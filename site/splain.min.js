"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),Splain=function(){function e(){_classCallCheck(this,e),this.regex={groupSelector:/\{.+?\}/g,chanceSelector:/\?[0-9]*/,quoteChecker:/".+"/},this.templates={}}return _createClass(e,[{key:"addTemplate",value:function(e,t,r){if(r&&(!r||void 0!==this.templates[e]))throw"the template group "+e+"already exists";this.templates[e]=t}},{key:"getTemplate",value:function(e){return this.templates[e]}},{key:"$trimGroup",value:function(e){return e.substring(1,e.length-1)}},{key:"$findGroups",value:function(e){return e.match(this.regex.groupSelector)}},{key:"$findInputs",value:function(e){return e=e.replace(/[\?|](?=([^"]*"[^"]*")*[^"]*$)/g," "),e.split(" ").filter(function(e){return""!=e})}},{key:"$getExecutionArray",value:function(e){for(var t=this.$findInputs(e),r=[];e.length>0;)if(" "==e[0])e=e.slice(1);else if(0==t.length||e.indexOf(t[0])>0)if("?"==e[0]){var n=e.match(this.regex.chanceSelector)[0];r.push({value:n,type:"?"}),e=e.replace(n,"")}else r.push({value:e[0],type:e[0]}),e=e.slice(1);else r.push({value:t[0],type:"input"}),e=e.replace(t[0],""),t.shift();return r}},{key:"$getNearestInputLeft",value:function(e,t){for(var r=t-1;r>=0;r--)if("input"===e[r].type)return r;return-1}},{key:"$getNearestInputRight",value:function(e,t){for(var r=t+1;r<e.length;r++)if("input"===e[r].type)return r;return-1}},{key:"$processOrOperators",value:function(e){for(var t=0;t<e.length;t++)if("|"==e[t].type)if(Math.floor(2*Math.random())){var r=this.$getNearestInputLeft(e,t);if(r>=0){var n=t-r+1;e.splice(r,n),t=r-1}}else{var a=this.$getNearestInputRight(e,t);if(a>=0){a+1<e.length&&"?"==e[a+1].type&&a++;var u=a-t+1;e.splice(t,u),t-=1}}return e}},{key:"$processConditionalOperators",value:function(e){for(var t=0;t<e.length;t++)if("?"==e[t].type){var r=2|e[t].value.replace("?","");0==Math.floor(Math.random()*r)?(e.splice(t-1,2),t-=2):(e.splice(t,1),t-=1)}return e}},{key:"$processInputs",value:function(e){for(var t=0;t<e.length;t++)if("input"==e[t].type)if(this.regex.quoteChecker.test(e[t].value))e[t].value=this.$trimGroup(e[t].value),e[t].type="output";else{if(void 0===this.templates[e[t].value])throw"template "+e[t].value+"doesnt exist";var r=this.templates[e[t].value];e[t].value=r[Math.floor(Math.random()*r.length)],e[t].type="output"}return e}},{key:"$processGroup",value:function(e){this.$processOrOperators(e),this.$processConditionalOperators(e),this.$processInputs(e)}},{key:"$containsOnlyInputs",value:function(e){var t=!0;return e.forEach(function(e){"input"!==e.type&&(t=!1)}),t}},{key:"$compileGroup",value:function(e){var t=0,r=[],n="";for(e=this.$trimGroup(e);t<5&&(0==t||!this.$containsOnlyInputs(r));)r=this.$getExecutionArray(e),this.$processGroup(r),n=r.map(function(e){return e.value}).join(" "),r=this.$getExecutionArray(n),t++;return n}},{key:"compile",value:function(e){for(var t=this,r=this.$findGroups(e),n=0;r;)if(n++,r.forEach(function(r){var n=t.$compileGroup(r);e=e.replace(r,n)}),r=this.$findGroups(e),n>5)throw"reached max stack";return e}}]),e}();